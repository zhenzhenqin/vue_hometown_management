<template>
  <div class="doc-container">
    <div class="doc-sidebar">
      <div class="sidebar-header">
        <el-icon><Reading /></el-icon> <span>CONTENTS</span>
      </div>
      <ul class="toc-list">
        <li 
          v-for="(item, index) in toc" 
          :key="index"
          :class="{ active: activeSection === item.id, 'sub-item': item.level > 1 }"
          @click="scrollTo(item.id)"
        >
          {{ item.text }}
        </li>
      </ul>
    </div>

    <div class="doc-content markdown-body" ref="contentRef" @scroll="handleScroll">
      <div v-html="parsedMarkdown"></div>
      
      <div class="doc-footer">
        Generated by Hometown System Generator &copy; 2025
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, nextTick } from 'vue'
import { Reading } from '@element-plus/icons-vue'
import { marked } from 'marked'
import hljs from 'highlight.js'
import 'highlight.js/styles/github-dark-dimmed.css'

// --- ğŸ“ é¡¹ç›®æ ¸å¿ƒæ–‡æ¡£ (Markdown) ---
// âœ¨ å…³é”®ä¿®å¤ï¼šæ‰€æœ‰çš„ä»£ç å—ç¬¦å· ``` éƒ½å·²è½¬ä¹‰ä¸º \`\`\`ï¼Œé˜²æ­¢ Vue ç¼–è¯‘å™¨æŠ¥é”™
const markdownContent = `
# è¡¢å·åœ°åŒºä¿¡æ¯ç®¡ç†ç³»ç»Ÿ (Hometown Management System)

> **ç‰ˆæœ¬**: v1.0.5
> **å¼€å‘è€…**: mjc (23H034160336)  
> **çŠ¶æ€**: ğŸŸ¢ å·²éƒ¨ç½² (Stable)

---

## 1. é¡¹ç›®æ¦‚è¿° (Overview)

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªè‡´åŠ›äº**å¼˜æ‰¬è¡¢å·æ–‡åŒ–ã€æ¨å¹¿åœ°æ–¹ç‰¹è‰²**çš„å…¨æ ˆä¿¡æ¯ç®¡ç†å¹³å°ã€‚ç³»ç»Ÿé›†æˆäº†**æ–‡åŒ–é—äº§å±•ç¤ºã€ç‰¹äº§æ¨å¹¿ã€æ—…æ¸¸æ™¯ç‚¹å¯¼èˆª**ä»¥åŠ**åå°æ•°æ®å¯è§†åŒ–ç®¡ç†**ç­‰åŠŸèƒ½ã€‚

**v1.0.5 æ ¸å¿ƒå‡çº§**ï¼šé‡ç‚¹å¢å¼ºäº†ç³»ç»Ÿçš„**å®‰å…¨æ€§**ä¸**å®¡è®¡èƒ½åŠ›**ï¼Œå…¨é¢å®è£…äº†**IPå±åœ°ç›‘æ§ç³»ç»Ÿ**ï¼Œå¹¶ä¼˜åŒ–äº†åº•å±‚æ•°æ®åº“äº¤äº’é€»è¾‘ã€‚

---

## 2. æŠ€æœ¯æ ˆ (Tech Stack)

### ğŸ› ï¸ åç«¯ (Backend)
-   **æ ¸å¿ƒæ¡†æ¶**: Spring Boot 2.7.x
-   **ORM**: MyBatis / MyBatis-Plus
-   **æ•°æ®åº“**: MySQL 8.0
-   **IPè§£æ**: **Ip2Region (ç¦»çº¿ IP åº“ï¼Œæ¯«ç§’çº§æŸ¥è¯¢)** [NEW]
-   **ç¼“å­˜**: Redis (ç”¨äºä¼šè¯ç®¡ç†ä¸çƒ­ç‚¹æ•°æ®ç¼“å­˜)
-   **å®‰å…¨**: JWT (JSON Web Token) é‰´æƒ
-   **ç›‘æ§**: OSHI (System Hardware Information) 
-   **å·¥å…·**: Swagger/Knife4j, Lombok, FastJSON
-   **äº‘æœåŠ¡**: é˜¿é‡Œäº‘ OSS (å¯¹è±¡å­˜å‚¨)

### ğŸ’» å‰ç«¯ (Frontend)
-   **æ¡†æ¶**: Vue 3 (Composition API)
-   **æ„å»º**: Vite 4.x
-   **UI ç»„ä»¶åº“**: Element Plus (è¡¨æ ¼è‡ªé€‚åº”ä¼˜åŒ–)
-   **å›¾è¡¨**: ECharts 5.x (æ•°æ®å¤§å±)
-   **åœ°å›¾**: ç™¾åº¦åœ°å›¾ JavaScript API GL
-   **HTTP**: Axios

---

## 3. ç³»ç»Ÿæ¶æ„ (Architecture)

\`\`\`mermaid
graph TD
    User[ç”¨æˆ·/ç®¡ç†å‘˜] -->|ç™»å½•/æ“ä½œ| Gateway[Nginx / ç½‘å…³]
    Gateway --> Server(Spring Boot åç«¯)
    
    subgraph "æ ¸å¿ƒæœåŠ¡å±‚"
    Server -->|è§£æIP| Ip2Region[IP å±åœ°åº“]
    Server -->|è¯»å†™| DB[(MySQL æ•°æ®åº“)]
    Server -->|ç¼“å­˜| Cache[(Redis)]
    Server -->|ç›‘æ§| Hardware[OSHI ç¡¬ä»¶ç›‘æ§]
    end
    
    subgraph "å®‰å…¨å±‚"
    Git[Git ä»“åº“] --x|å¿½ç•¥| Sensitive[.yml é…ç½®æ–‡ä»¶]
    end
\`\`\`

---

## 4. æ ¸å¿ƒåŠŸèƒ½æ¨¡å— (Modules)

### ğŸ‘® å®‰å…¨ä¸å®¡è®¡ (Security & Audit) **[NEW]**
-   **IP å±åœ°ç›‘æ§**: è‡ªåŠ¨è·å–ç”¨æˆ·å®¢æˆ·ç«¯ IPï¼Œç¦»çº¿è§£æå‡ºâ€œçœä»½Â·åŸå¸‚â€ï¼ˆå¦‚ï¼šæµ™æ±ŸÂ·å®æ³¢ï¼‰ï¼Œå¹¶è®°å½•åœ¨æ•°æ®åº“ä¸­ã€‚
-   **ç™»å½•è¿½è¸ª**: ç®¡ç†å‘˜å’Œç”¨æˆ·ç™»å½•/æ³¨å†Œæ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æœ€åç™»å½• IP å’Œåœ°ç‚¹ã€‚
-   **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**: é…ç½® Git å¿½ç•¥è§„åˆ™ï¼Œé˜²æ­¢é˜¿é‡Œäº‘ AK/SK æ³„éœ²ã€‚

### ğŸ—ºï¸ åˆ†å¸ƒåœ°å›¾ (Attraction Map)
-   **å…¨åŸŸå¯¼è§ˆ**: é›†æˆç™¾åº¦åœ°å›¾ GLï¼Œç›´è§‚å±•ç¤ºè¡¢å·æ‰€æœ‰æ™¯ç‚¹çš„åœ°ç†åˆ†å¸ƒã€‚
-   **æ™ºèƒ½å®šä½**: æ”¯æŒæ•°æ®åº“ç»çº¬åº¦ç›´æ¥æ‰“ç‚¹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒåŸºäºåœ°å€çš„è‡ªåŠ¨è§£æå…œåº•æ–¹æ¡ˆã€‚
-   **æ²‰æµ¸ä½“éªŒ**: 3D å€¾æ–œè§†è§’ + é£è¡Œè·³è½¬åŠ¨ç”» (FlyTo)ã€‚

### ğŸ–¥ï¸ æœåŠ¡ç›‘æ§ (Server Monitor)
-   **å®æ—¶ä»ªè¡¨ç›˜**: å®æ—¶ç›‘æ§æœåŠ¡å™¨çš„ CPU ä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ç‡ã€‚
-   **ç¯å¢ƒä¿¡æ¯**: å±•ç¤ºæœåŠ¡å™¨æ“ä½œç³»ç»Ÿã€IP åœ°å€ã€Java ç‰ˆæœ¬ã€é¡¹ç›®è·¯å¾„ç­‰ã€‚

### ğŸ›ï¸ æ–‡åŒ–ä¸ç‰¹äº§ (Culture & Food)
-   **éé—å±•ç¤º**: æ”¶å½•è¡¢å·å„ç±»éç‰©è´¨æ–‡åŒ–é—äº§ï¼Œæ”¯æŒå¯Œæ–‡æœ¬å±•ç¤ºã€‚
-   **ç‰¹äº§ç¾é£Ÿ**: ä¸‰å¤´ä¸€æŒã€çƒ¤é¥¼ç­‰ç‰¹è‰²ç¾é£Ÿä»‹ç»ã€‚

---

## 5. æ ¸å¿ƒä»£ç ç‰‡æ®µ (Code Snippets)

### ğŸŒ 1. IP å±åœ°æ™ºèƒ½è§£æ (Java) **[NEW]**
\`\`\`java
/**
 * æ ¹æ® IP è§£æåŸå¸‚ä¿¡æ¯
 * è¾“å…¥: 110.19.106.1 -> è¾“å‡º: æµ™æ±ŸÂ·å®æ³¢
 */
public static String getCityInfo(String ip) {
    try {
        // 1. æŸ¥è¯¢ IP åº“ (æ ¼å¼: å›½å®¶|åŒºåŸŸ|çœä»½|åŸå¸‚|ISP)
        String region = searcher.search(ip);
        String[] parts = region.split("\\\\|"); // è½¬ä¹‰ç®¡é“ç¬¦
        
        // 2. æå–å¹¶ç®€åŒ–
        String province = parts[2];
        String city = parts[3];
        
        // 3. æ™ºèƒ½æ‹¼æ¥
        return simplifyArea(province) + "Â·" + simplifyArea(city);
    } catch (Exception e) {
        return "æœªçŸ¥";
    }
}
\`\`\`

### ğŸ”§ 2. MyBatis åŠ¨æ€æ›´æ–°ä¿®å¤ (XML) **[NEW]**
\`\`\`xml
<update id="updateIpAndCity">
    update user
    <set>
        <if test="ip != null">ip = #{ip},</if>
        <if test="city != null">city = #{city},</if>
        update_time = now(), </set>
    where id = #{id}
</update>
\`\`\`

### ğŸ“¡ 3. OSHI è·å–ç³»ç»Ÿä¿¡æ¯ (Java)
\`\`\`java
public void copyTo() throws Exception {
    SystemInfo si = new SystemInfo();
    HardwareAbstractionLayer hal = si.getHardware();
    setCpuInfo(hal.getProcessor());
    setMemInfo(hal.getMemory());
    setSysInfo();
}
\`\`\`

### ğŸ—ºï¸ 4. ç™¾åº¦åœ°å›¾æ™ºèƒ½æ‰“ç‚¹ (JavaScript)
\`\`\`javascript
const addCreativeMarker = (item) => {
  // ğŸŸ¢ ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“ç»çº¬åº¦ (é«˜æ€§èƒ½)
  if (item.longitude && item.latitude) {
    const point = new BMapGL.Point(item.longitude, item.latitude)
    createMarkerLogic(point, item)
  } else {
    // ğŸŸ¡ å…œåº•ï¼šä½¿ç”¨åœ°å€è§£æ
    const myGeo = new BMapGL.Geocoder()
    myGeo.getPoint('è¡¢å·å¸‚ ' + item.name, (p) => {
      if (p) createMarkerLogic(p, item)
    }, 'è¡¢å·å¸‚')
  }
}
\`\`\`

---

## 6. éƒ¨ç½²æŒ‡å— (Deployment)

### å¯åŠ¨æ­¥éª¤
1.  **æ•°æ®åº“**: å¯¼å…¥ \`init.sql\`ã€‚
2.  **åç«¯**: ä¿®æ”¹ \`application.yml\` (æ³¨æ„ä¸è¦æäº¤åˆ° Git)ï¼Œè¿è¡Œ \`HometownApplication.java\`ã€‚
3.  **å‰ç«¯**: 
    \`\`\`bash
    cd vue_hometown_management
    npm install
    npm run dev
    \`\`\`

---

## 7. æ›´æ–°æ—¥å¿— (Changelog)

-   **v1.0.5 (2025-12-28)**: 
    -   âœ¨ **[Feature]** å…¨é¢å®è£… **IP å±åœ°ç›‘æ§** åŠŸèƒ½ï¼Œæ”¯æŒç”¨æˆ·/ç®¡ç†å‘˜ç™»å½•æ—¶è‡ªåŠ¨è®°å½•æ‰€åœ¨åŸå¸‚ã€‚
    -   ğŸ› **[Bugfix]** ä¿®å¤äº† MyBatis \`update\` è¯­å¥ä¸­å› å¤šä½™é€—å·å¯¼è‡´çš„ \`SQLSyntaxErrorException\`ã€‚
    -   ğŸ”’ **[Security]** ä¿®å¤äº† Git å†å²è®°å½•ä¸­çš„ **é˜¿é‡Œäº‘ AK æ³„éœ²** é—®é¢˜ï¼Œé‡æ„äº† \`.gitignore\` è§„åˆ™ã€‚
    -   ğŸ’„ **[UI]** ä¼˜åŒ–äº†åå°ç®¡ç†è¡¨æ ¼ï¼ŒIP å½’å±åœ°åˆ—æ”¯æŒè‡ªé€‚åº”å®½åº¦ã€‚

-   **v1.0.4 (2025-12-19)**:
    -   âœ¨ **[Feature]** æ–°å¢ **â€œåˆ†å¸ƒåœ°å›¾â€** æ¨¡å—ï¼Œæ”¯æŒå…¨å± 3D åœ°å›¾å¯¼è§ˆã€‚
    -   âœ¨ **[Feature]** æ–°å¢ **â€œæœåŠ¡ç›‘æ§â€** æ¨¡å—ï¼ŒåŸºäº OSHI å®æ—¶å±•ç¤ºæœåŠ¡å™¨çŠ¶æ€ã€‚

-   **v1.0.0 (2025-09-15)**: 
    -   ğŸ‰ é¡¹ç›®åˆå§‹åŒ–ï¼Œå®ŒæˆåŸºç¡€ CRUD åŠŸèƒ½ã€‚

---

> **Copyright**: 2025 è¡¢å·åœ°åŒºä¿¡æ¯ç®¡ç†ç³»ç»Ÿ Team. All Rights Reserved.
`

// --- é€»è¾‘å¤„ç† ---
const contentRef = ref(null)
const activeSection = ref('')

// é…ç½® Marked
marked.setOptions({
  renderer: new marked.Renderer(),
  highlight: function(code, lang) {
    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
    return hljs.highlight(code, { language }).value;
  },
  langPrefix: 'hljs language-',
  pedantic: false,
  gfm: true,
  breaks: false,
  sanitize: false,
  smartLists: true,
  smartypants: false,
  xhtml: false
});

const parsedMarkdown = computed(() => marked(markdownContent))

// ç”Ÿæˆç›®å½• (TOC)
const toc = computed(() => {
  const reg = /^#+\s+(.*)$/gm
  const matches = markdownContent.match(reg) || []
  return matches.map((item, index) => {
    const level = item.match(/^#+/)[0].length
    const text = item.replace(/^#+\s+/, '')
    const id = `heading-${index}`
    return { level, text, id }
  })
})

// ä¸ºç”Ÿæˆçš„ HTML æ·»åŠ  ID ä»¥ä¾¿è·³è½¬
onMounted(async () => {
  await nextTick()
  const headers = contentRef.value.querySelectorAll('h1, h2, h3')
  headers.forEach((header, index) => {
    header.id = `heading-${index}`
  })
})

// æ»šåŠ¨è·³è½¬
const scrollTo = (id) => {
  const el = document.getElementById(id)
  if (el) {
    el.scrollIntoView({ behavior: 'smooth' })
    activeSection.value = id
  }
}

const handleScroll = () => {
  // scroll logic
}
</script>

<style scoped>
/* æ ·å¼ä¿æŒä¸å˜ */
.doc-container {
  display: flex;
  height: 100%;
  background-color: #ffffff;
  font-family: 'Segoe UI', sans-serif;
  overflow: hidden; 
}

.doc-sidebar {
  width: 280px;
  background-color: #f8f9fa;
  border-right: 1px solid #e9ecef;
  padding: 30px 20px;
  overflow-y: auto;
  flex-shrink: 0;
}

.sidebar-header {
  font-size: 14px;
  font-weight: 800;
  color: #adb5bd;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: 1px;
}

.toc-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.toc-list li {
  padding: 8px 12px;
  font-size: 14px;
  color: #495057;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
  margin-bottom: 4px;
  border-left: 3px solid transparent;
}

.toc-list li:hover {
  background-color: #e9ecef;
  color: #212529;
}

.toc-list li.active {
  background-color: #e7f5ff;
  color: #1a5e38;
  border-left-color: #1a5e38;
  font-weight: 600;
}

.toc-list li.sub-item {
  padding-left: 25px;
  font-size: 13px;
  color: #868e96;
}

.doc-content {
  flex: 1;
  padding: 40px 60px;
  overflow-y: auto;
  scroll-behavior: smooth;
  background-color: #fff;
}

:deep(.markdown-body) {
  color: #24292f;
  line-height: 1.6;
}

:deep(h1) {
  font-size: 2.5em;
  padding-bottom: 0.3em;
  border-bottom: 1px solid #eaecef;
  margin-bottom: 24px;
  color: #1a5e38;
}

:deep(h2) {
  font-size: 1.75em;
  padding-bottom: 0.3em;
  border-bottom: 1px solid #eaecef;
  margin-top: 36px;
  margin-bottom: 20px;
}

:deep(h3) {
  font-size: 1.4em;
  margin-top: 24px;
  margin-bottom: 16px;
}

:deep(p) {
  margin-bottom: 16px;
}

:deep(blockquote) {
  padding: 0 1em;
  color: #6a737d;
  border-left: 0.25em solid #dfe2e5;
  background-color: #f6f8fa;
  padding: 16px;
  margin: 0 0 16px 0;
  border-radius: 4px;
}

:deep(pre) {
  background-color: #2d333b; 
  padding: 16px;
  border-radius: 8px;
  overflow: auto;
  margin-bottom: 20px;
}

:deep(code) {
  font-family: 'Consolas', 'Monaco', monospace;
}

:deep(pre code) {
  color: #adbac7;
  background: transparent;
  padding: 0;
}

:deep(:not(pre) > code) {
  padding: 0.2em 0.4em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(175, 184, 193, 0.2);
  border-radius: 6px;
}

:deep(ul) {
  padding-left: 2em;
  margin-bottom: 16px;
}

:deep(li) {
  margin-bottom: 4px;
}

.doc-footer {
  margin-top: 60px;
  padding-top: 20px;
  border-top: 1px solid #eee;
  text-align: center;
  color: #999;
  font-size: 12px;
}

.doc-content::-webkit-scrollbar,
.doc-sidebar::-webkit-scrollbar {
  width: 6px;
}
.doc-content::-webkit-scrollbar-thumb,
.doc-sidebar::-webkit-scrollbar-thumb {
  background-color: #ddd;
  border-radius: 3px;
}
</style>